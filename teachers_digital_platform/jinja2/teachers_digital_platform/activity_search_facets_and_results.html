{% import 'atoms/tag.html' as tag %}
{% import 'molecules/pagination.html' as pagination with context %}
{% from 'organisms/expandable.html' import expandable with context %}

{% macro build_nested_facets(facets, type, is_child=False) %}
    <ul class="m-list__unstyled{% if is_child: %} children{% endif %}">
        {% for facet in facets %}
            {% if facet.children %}
                <div class="aggregation-branch">
                    <li class="parent m-form-field m-form-field__checkbox body-copy">
                        <input type="checkbox" aria-label="{{ facet.title }}" class="a-checkbox" id="{{ type }}--{{ facet.title | trim | slugify}}" name="{{ type }}" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                        <label class="toggle a-label{% if facet.child_selected  and not facet.selected %} indeterminate{% endif %}" for="{{ type }}--{{ facet.title | trim | slugify}}"></label>
                        <button class="a-btn a-btn__link" title="{{ facet.title }}"><span>{{ facet.title }}</span><span class="cf-icon cf-icon-down"></span></button>
                    </li>
                    {{ build_nested_facets(facet.children, type, True) }}
                </div>
                {% else %}
                <li class=" m-form-field m-form-field__checkbox body-copy">
                    <input type="checkbox" aria-label="{{ facet.title }}" class="a-checkbox" id="{{ type }}--{{ facet.title | trim | slugify}}" name="{{ type }}" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                    <label class="a-label" for="{{ type }}--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
{% endmacro %}

{% macro  build_nested_filter_tags(facets, type) %}
    {% for facet in facets %}
        {% if facet.selected %}
            {% set input_id = '#' + type | trim | replace("_","-") + "--" + facet.title | trim | slugify %}
            {{ tag.render({
                'label': facet.title,
                'value': input_id,
                'behavior': 'clear-filter'
            }) }}
        {% endif %}
        {% if facet.children %}
            {{ build_nested_filter_tags(facet.children, type) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

<aside class="content_sidebar">
    <section class="o-filter-panel">
        <h3 class="u-mt30">Filter results by</h3>
        <form action="." method="get" data-js-hook="behavior_change-filter">
            <input type="hidden" name="q" value="{% if search_query: %}{{ search_query }}{% endif %}">
            <input type="hidden" name="page" inputmode="numeric" value="1">
            <p>Narrow your search by selecting specific activity features.</p>
            {% if facets.building_block %}
            <hr />
                {% if 'building_block' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Building block',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.building_block %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="building-block--{{ facet.title | trim | slugify}}" name="building_block" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="building-block--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.school_subject %}
            <hr />
                {% if 'school_subject' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'School subject',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.school_subject %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="school-subject--{{ facet.title | trim | slugify}}" name="school_subject" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="school-subject--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.topic %}
            <hr />
                {% if 'topic' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Topic',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    {{ build_nested_facets(facets.topic, 'topic') }}
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.grade_level or facets.age_range or facets.special_population %}<h3 class="u-mt45">Audience</h3>{% endif %}
            {% if facets.grade_level %}
            <hr />
                {% if 'grade_level' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Grade level',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.grade_level %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="grade-level--{{ facet.title | trim | slugify}}" name="grade_level" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="grade-level--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.age_range %}
            <hr />
                {% if 'age_range' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Age range',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.age_range %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="age-range--{{ facet.title | trim | slugify}}" name="age_range" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="age-range--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.special_population %}
            <hr />
                {% if 'special_population' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Special population',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.special_population %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="special-population--{{ facet.title | trim | slugify}}" name="special_population" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="special-population--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.activity_type or facets.teaching_strategy or facets.blooms_taxonomy_level or facets.activity_duration %}<h3 class="u-mt45">Activity characteristics</h3>{% endif %}
            {% if facets.activity_type %}
            <hr />
                {% if 'activity_type' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Activity type',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.activity_type %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="activity-type--{{ facet.title | trim | slugify}}" name="activity_type" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="activity-type--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.teaching_strategy %}
            <hr />
                {% if 'teaching_strategy' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Teaching strategy',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.teaching_strategy %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="teaching-strategy--{{ facet.title | trim | slugify}}" name="teaching_strategy" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="teaching-strategy--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.blooms_taxonomy_level %}
            <hr />
                {% if 'blooms_taxonomy_level' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Bloom\'s Taxonomy level',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.blooms_taxonomy_level %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="blooms-taxonomy-level--{{ facet.title | trim | slugify}}" name="blooms_taxonomy_level" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="blooms-taxonomy-level--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.activity_duration %}
            <hr />
                {% if 'activity_duration' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Activity duration',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.activity_duration %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="activity-duration--{{ facet.title | trim | slugify}}" name="activity_duration" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="activity-duration--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.council_for_economic_education or facets.jump_start_coalition %}<h3 class="u-mt45">National standards</h3>{% endif %}
            {% if facets.council_for_economic_education %}
            <hr />
                {% if 'council_for_economic_education' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Council for Economic Education',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.council_for_economic_education %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="council-for-economic-education--{{ facet.title | trim | slugify}}" name="council_for_economic_education" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="council-for-economic-education--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
            {% if facets.jump_start_coalition %}
            <hr />
                {% if 'jump_start_coalition' in page.results.expanded_facets %}
                    {% set is_expanded = true %}
                {% else %}
                    {% set is_expanded = false %}
                {% endif %}
                {% set expandable_settings = {
                    'label': 'Jump$tart Coalition',
                    'is_expanded': is_expanded,
                    'is_midtone': true,
                    'hide_cue_label': true
                } %}
                {% call() expandable(expandable_settings) %}
                <div>
                    <ul class="m-list__unstyled">
                        {% for facet in facets.jump_start_coalition %}
                        <li class="m-form-field m-form-field__checkbox">
                            <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title}}" id="jump-start-coalition--{{ facet.title | trim | slugify}}" name="jump_start_coalition" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                            <label class="a-label" for="jump-start-coalition--{{ facet.title | trim | slugify}}">{{ facet.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcall %}
            {% endif %}
        </form>
    </section>
</aside>
<section id="tdp-search-results" class="content_main">
    <a id="content_main"></a>
    {% if activities %}
    <div class="results_header">
        <div class="results_count">
            <h3>Showing {{ activities | length }} of {{ page.results.total_results }}  results</h3>
        </div>
        {% if show_filters %}
        <div class="filters_applied">
            <span class="filters_applied-label">
                Filters applied:
            </span>
            <div class="filters_tags">
                {% for facet_name, facet_items in facets.items() %}
                    {% if facet_name == 'topic'%}
                        {{ build_nested_filter_tags(facet_items, facet_name) }}
                    {% else %}
                        {% for facet in facet_items %}
                            {% if facet.selected %}
                                {% set input_id = '#' + facet_name | trim | replace("_","-") + "--" + facet.title | trim | slugify %}
                                {{ tag.render({
                                    'label': facet.title,
                                    'value': input_id,
                                    'behavior': 'clear-filter'
                                }) }}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </div>
            <button class="a-btn a-btn__link a-btn__warning a-micro-copy filters_clear"
                    data-js-hook="behavior_clear-all">
                Clear all filters
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}
    <ul class="m-list__unstyled">
        {% for result in activities %}
            {% if result %}
            <li>{% include "activity_search_result.html" %}</li>
            {% endif %}
        {% else %}
        <li> No results found.</li>
        {% endfor %}

    </ul>
    <div class="results_paginator">
        {{ pagination.render( paginator.num_pages, current_page, '', '', 'Previous', 'Next' ) }}
    </div>
</section>